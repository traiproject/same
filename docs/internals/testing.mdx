---
title: "Testing Strategy"
description: "The testing philosophy, strategy, and regression prevention mechanisms for same."
---

## Philosophy

`same` follows a pragmatic testing strategy adapted for a CLI build tool. The
goal is to ensure reliability and prevent regressions in critical areas like
caching and environment isolation.

<CardGroup cols={2}>
  <Card title="Unit Tests" icon="puzzle-piece">
    **Fast & Isolated.** Verify domain logic (Graphs, DAGs) and independent adapters.
  </Card>
  <Card title="Integration Tests" icon="cog">
    **Wiring & Concurrency.** Verify the Scheduler, Executor, and TUI coordination.
  </Card>
  <Card title="Golden Tests" icon="star">
    **Strict Regression Checks.** Ensure deterministic output for Hashing and Nix generation.
  </Card>
  <Card title="E2E Tests" icon="box">
    **Black Box.** (Future) Validate the compiled binary against real workspaces.
  </Card>
</CardGroup>

## 1. Unit Testing

We use standard Go tests to verify individual components in isolation.
Dependencies should be mocked using `gomock`.

### Core Domain

- **Scope:** `internal/core/domain`
- **Focus:** Pure logic. No I/O or mocking required.
- **Critical Scenarios:**
  - **Graph Cycles:** `Validate()` must correctly identify $A \to B \to A$
    loops.
  - **Determinism:** Topological sort order must be stable across runs.
  - **EnvID:** `GenerateEnvID` must produce the same hash regardless of map
    iteration order.

### Adapters

- **Nix (`internal/adapters/nix`):** Mock the `DependencyResolver` to avoid
  network calls.
- **TUI (`internal/adapters/tui`):** Test the `Update()` loop. Send messages
  (e.g., `MsgTaskStart`) and assert state transitions. Do _not_ test the string
  output of `View()` as it is brittle.

## 2. Integration Testing

Integration tests focus on the interaction between components, particularly the
Scheduler.

### Scheduler & Concurrency

- **Tooling:** Use `testing/synctest` (Go 1.25+) to simulate time and goroutines
  deterministically.
- **Scenarios:**
  - **Diamond Dependencies:** Ensure shared dependencies run exactly once.
  - **Failure Propagation:** If a dependency fails, dependent tasks must be
    skipped.
  - **Cancellation:** Ensure `context.Cancel()` halts execution immediately.

## 3. Regression Prevention (Golden Tests)

Certain outputs in `same` must never change unexpectedly, as doing so would
invalidate caches for all users. We use "Golden Tests" (Snapshot tests) to guard
these.

### Hashing Stability

- **Location:** `internal/adapters/fs/hasher_golden_test.go`
- **Concept:** Hash a static, hardcoded task structure. Assert that the
  resulting hash matches a known constant string.
- **Why:** Prevents accidental logic changes (e.g., reordering fields in the
  hasher) that would break cache compatibility.

### Nix Expression Stability

- **Location:** `internal/adapters/nix/golden_test.go`
- **Concept:** Generate a Nix expression for a complex toolset. Compare the
  string output strictly against a stored `.nix` file.
- **Why:** Ensures the hermetic environment definition remains stable.

## 4. End-to-End (E2E) Testing (Future)

E2E tests treat `same` as a black box. They compile the binary and run it
against a real temporary workspace.

### Harness

We plan to use `testscript` (or a similar Go harness) to:

1. Compile `same` to a temp location.
2. Create a sandbox workspace.
3. Run commands and assert on Exit Code, Stdout, and File Existence.

### Critical Scenarios

| Scenario        | Expectation                                                              |
| :-------------- | :----------------------------------------------------------------------- |
| **Cold Run**    | Exit 0. Output contains "Exec: build". Artifact exists.                  |
| **Cached Run**  | Exit 0. Output contains "Skipped (Cached)". Duration ~0ms.               |
| **Dirty Input** | Modify source file. Run again. Output contains "Exec: build".            |
| **Hermeticity** | Task checks for a host env var (e.g., `SECRET`). It must be empty/unset. |
