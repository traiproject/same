syntax = "proto3";

package daemon.v1;

option go_package = "go.trai.ch/same/api/daemon/v1;daemonv1";

service DaemonService {
  // Ping checks daemon health and resets the inactivity timer.
  rpc Ping(PingRequest) returns (PingResponse);

  // Status returns current daemon status information.
  rpc Status(StatusRequest) returns (StatusResponse);

  // Shutdown initiates graceful daemon termination.
  rpc Shutdown(ShutdownRequest) returns (ShutdownResponse);

  // GetGraph returns the parsed task graph, using mtime for cache invalidation.
  rpc GetGraph(GetGraphRequest) returns (GetGraphResponse);

  // GetEnvironment returns resolved Nix environment variables for a toolset.
  rpc GetEnvironment(GetEnvironmentRequest) returns (GetEnvironmentResponse);
}

message PingRequest {}

message PingResponse {
  // idle_remaining_seconds is the time remaining before auto-shutdown.
  int64 idle_remaining_seconds = 1;
}

message StatusRequest {}

message StatusResponse {
  bool running = 1;
  int32 pid = 2;
  int64 uptime_seconds = 3;
  int64 last_activity_unix = 4;
  int64 idle_remaining_seconds = 5;
}

message ShutdownRequest {
  // graceful indicates whether to wait for in-flight operations.
  bool graceful = 1;
}

message ShutdownResponse {
  bool success = 1;
}

message ConfigMtime {
  string path = 1;
  int64 mtime_unix_nano = 2;
}

message GetGraphRequest {
  string cwd = 1;
  repeated ConfigMtime config_mtimes = 2;
}

message TaskProto {
  string name = 1;
  repeated string command = 2;
  repeated string inputs = 3;
  repeated string outputs = 4;
  map<string, string> tools = 5;
  repeated string dependencies = 6;
  map<string, string> environment = 7;
  string working_dir = 8;
  string rebuild_strategy = 9;
}

message GetGraphResponse {
  bool cache_hit = 1;
  string root = 2;
  repeated TaskProto tasks = 3;
}

message GetEnvironmentRequest {
  string env_id = 1;
  map<string, string> tools = 2;
}

message GetEnvironmentResponse {
  bool cache_hit = 1;
  repeated string env_vars = 2;
}
