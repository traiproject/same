### System Constraints & Development Standards

1. Environment & Workflow
- **Nix Environment:** All build, test, lint, and formatting commands **must** be executed within the Nix development environment.
  - *Usage:* Prefix commands with `nix develop -c`.
  - *Example:* `nix develop -c go test ./...`
- **Version Control:**
  - **Tool:** Use Jujutsu (`jj`) for version control.
  - **Commits:** Follow the **Conventional Commits** format (`type(scope): description`).
  - *Types:* `feat`, `fix`, `refactor`, `test`, `chore`, `style`, `docs`, `build`, `ci`.
- **Go Version:** Utilize **Go 1.25+**.

2. Architectural Integrity

Strictly adhere to **Clean Architecture** principles and the 4-layer dependency model enforced by `depguard`:
1. **Core** (`internal/core`):
   - Contains pure domain logic and port interfaces.
   - **Forbidden Dependencies:** `engine`, `adapters`, `app`.
   - *Note:* Domain entities must remain serializable (JSON) and free of I/O logic.
2. **Engine** (`internal/engine`):
   - Contains complex business logic (e.g., Scheduler).
   - **Allowed Dependencies:** `core`.
   - **Forbidden Dependencies:** `adapters`, `app`.
3. **Adapters** (`internal/adapters`):
   - Contains infrastructure implementations (FS, Shell, Logger, Config).
   - **Allowed Dependencies:** `core` (ports).
   - **Forbidden Dependencies:** `engine`.
4. **App** (`internal/app`):
   - Orchestration layer tying `engine` and `adapters` together via Dependency Injection.
   - **Allowed Dependencies:** `core`, `engine`, `adapters` (interfaces preferred).

3. Coding Standards & Idioms
- **Modern Go Features:**
  - **Iterators:** Use `iter.Seq[T]` and `iter.Seq2[K,V]` for sequence traversals (instead of channel generators or slice returns).
  - **String Interning:** For high-frequency strings (Task names, paths, dependency keys), **always** use `domain.InternedString` (wrapping `unique.Handle`) to minimize memory footprint.
- **Error Handling:**
  - Strictly use the `go.trai.ch/zerr` library.
  - Wrap low-level errors: `zerr.Wrap(err, "context message")`.
  - Attach metadata: `zerr.With(err, "key", value)` (do not embed dynamic data in error strings).
- **Dependency Injection:** Prefer explicit dependency injection over global state. Interfaces should be defined where they are used (consumer-driven), typically in `internal/core/ports`.
- **Code Formatting & Imports:**
  - **Mandatory Tools:** The project uses `gci` (for deterministic import ordering) and `gofumpt` (for stricter formatting than `gofmt`).
  - **Execution:** You **must** use the versions bundled in the Nix environment to ensure consistency.
    - **Imports:** `nix develop -c gci write <PATH>`
      - *Example:* `nix develop -c gci write .`
    - **Formatting:** `nix develop -c gofumpt -l -w <PATH>`
      - *Example:* `nix develop -c gofumpt -l -w .`

4. Testing & Quality Assurance
- **Coverage:** Aim for **100% test coverage**; strict minimum is **80%**.
- **Testing Strategy:**
  - Prefer **table-driven tests** for logic.
  - Use `go.uber.org/mock` for interface mocking.
  - **Deterministic Concurrency:** For concurrent components (e.g., Scheduler), you **must** use the `testing/synctest` package (experimental) to ensure deterministic ordering without `time.Sleep`.
  - **Isolation:** Tests must not rely on global system state; use `t.TempDir()` for filesystem tests.
- **Mock Generation:** Interfaces in `internal/core/ports` must include `//go:generate mockgen ...` directives.
- **QA Cycle:**
  1. Run `nix develop -c golangci-lint run` (resolve **all** issues).
  2. Run `nix develop -c go test -race ./...` (ensure no regressions).

5. Domain-Specific Implementations
- **CLI (Cobra):**
  - Set `SilenceUsage: true` and `SilenceErrors: true` on commands.
  - Error reporting is the responsibility of `main.go` or the Logger adapter, not the library.
- **Logging:**
  - Use `log/slog` via `internal/adapters/logger`.
  - Logs must be written to `os.Stderr`.
  - Application logic must interact with the `ports.Logger` interface, not the concrete implementation.
- **File System:**
  - **Prohibited:** Do not use `path/filepath` or `os` directly for traversing trees or hashing in business logic.
  - **Required:** Use `fs.Walker` and `fs.Hasher` adapters (handles `.gitignore`, `.git`, `.jj` exclusion, and consistent hashing).

6. Configuration & Self-Validation (Dogfooding)
- **Schema Synchronization:**
  - If you modify `internal/adapters/config/schema.go` (e.g., adding new properties to `TaskDTO`), you **must**immediately update the root `bob.yaml` file to reflect these changes or demonstrate the new capability.
  - Ensure the example configuration in tests (`loader_test.go`) remains consistent with the new schema.
- **Compliance Verification:**
  - If you implement new validation rules (e.g., in `internal/core/domain/graph.go`) or change how configuration is loaded, you **must** verify that the project's own `bob.yaml` still passes validation.
  - The project must always be able to build itself using the latest code changes. Verification involves running `go run ./cmd/bob run build` (or the equivalent test command) to ensure the local configuration remains compliant.

